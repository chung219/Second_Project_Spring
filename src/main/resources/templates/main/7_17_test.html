<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
</head>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3fa5806dfe291fb3622cf85fca14b017&libraries=services,clusterer,drawing"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<body>

<div class="container">
    <div class="py-5 text-center">
        <h2>메인테스트 화면</h2>
        <div id="map" style="width:700px;height:900px;"></div>
        <button onclick="setOverlayMapTypeId('traffic')">교통정보 보기</button>
        <script>
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: new kakao.maps.LatLng(36.01683146793617, 129.42603381793853), // 지도의 중심좌표
                    level: 13 // 지도의 확대 레벨
                };
            // 지도를 생성합니다
            var map = new kakao.maps.Map(mapContainer, mapOption);

            // 지도에 추가된 지도타입정보를 가지고 있을 변수입니다
            var currentTypeId;

            // 버튼이 클릭되면 호출되는 함수입니다
            function setOverlayMapTypeId(maptype) {
                // 현재 지도 타입이 교통정보인지 확인합니다
                var isTrafficType = currentTypeId === kakao.maps.MapTypeId.TRAFFIC;

                if (maptype === 'traffic') {
                    // 현재 지도 타입이 교통정보이면 껐다 켭니다
                    if (isTrafficType) {
                        map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
                        currentTypeId = null;
                    } else {
                        // 교통정보 지도타입을 추가합니다
                        map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
                        currentTypeId = kakao.maps.MapTypeId.TRAFFIC;
                    }
                }
            }

            // // 지도에 교통정보를 표시하도록 지도타입을 추가합니다
            // map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);

            // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
            var mapTypeControl = new kakao.maps.MapTypeControl();

            // 지도에 컨트롤을 추가해야 지도위에 표시됩니다
            // kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
            var zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            // 주소-좌표 변환 객체를 생성합니다
            var geocoder = new kakao.maps.services.Geocoder();

            $(document).ready(function() {
                // 웹소켓 연결
                var socket = new WebSocket("ws://localhost:8060/");
                // 웹소켓 연결 성공 시 이벤트 핸들러
                socket.onopen = function(event) {
                    console.log("WebSocket connected.");
                };
                // 웹소켓으로부터 데이터 수신 시 이벤트 핸들러
                socket.onmessage = function(event) {
                    var receivedData = event.data;
                    console.log("Received data: " + receivedData);
                    new_marker(receivedData)
                };

                // 웹소켓 연결 종료 시 이벤트 핸들러
                socket.onclose = function(event) {
                    console.log("WebSocket disconnected.");
                };
            });

            function new_marker(received_data) {

                var nomal_info = JSON.parse(received_data);
                console.log("json:" + nomal_info)

                var infoArray = Array.isArray(nomal_info) ? nomal_info : [nomal_info];

                infoArray.forEach(function (address) {

                    var first_address = address['소재지주소']
                    var second_address = address['소새지상세주소']

                    // 주소로 좌표를 검색합니다
                    geocoder.addressSearch(first_address + second_address, function (result, status) {

                        // 정상적으로 검색이 완료됐으면
                        if (status === kakao.maps.services.Status.OK) {

                            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                            // 결과값으로 받은 위치를 마커로 표시합니다
                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: coords
                            });
                        }
                    });
                });
            }

            // // 인포윈도우로 장소에 대한 설명을 표시합니다
            // var infowindow = new kakao.maps.InfoWindow({
            //     content: '<div style="width:150px;text-align:center;padding:6px 0;">우리회사</div>'
            // });
            // infowindow.open(map, marker);
            //
            // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
            // map.setCenter(coords);

        </script>

    </div>
</body>
</html>